name: All Checks

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      env_selected: ${{ steps.setenv.outputs.env_selected }}
      retention_days: ${{ steps.setenv.outputs.retention_days }}
      timestamp: ${{ steps.setenv.outputs.timestamp }}
    steps:
      - name: Decide environment + retention
        id: setenv
        run: |
          # Decide environment
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            echo "env_selected=dev" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            echo "env_selected=staging" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "env_selected=prod" >> $GITHUB_OUTPUT
          else
            echo "env_selected=dev" >> $GITHUB_OUTPUT
          fi

          # Default retention = 30 days
          retention=30
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            retention=90
          fi
          echo "retention_days=$retention" >> $GITHUB_OUTPUT

          # Add UTC timestamp
          timestamp=$(date -u +"%Y%m%d-%H%M%S")
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT

  reset_quiet:
    needs: set-environment
    uses: ./.github/workflows/reset.yml
    with:
      environment: ${{ needs.set-environment.outputs.env_selected }}
    secrets: inherit

  ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  verify:
    runs-on: ubuntu-latest
    needs: [reset_quiet, ci, set-environment]
    steps:
      - name: Success summary
        if: "${{ needs.reset_quiet.result == 'success' && needs.ci.result == 'success' }}"
        run: |
          echo "✅ All Checks succeeded" > all-checks-summary.txt
          echo "Environment: ${{ needs.set-environment.outputs.env_selected }}" >> all-checks-summary.txt
          echo "Retention: ${{ needs.set-environment.outputs.retention_days }} days" >> all-checks-summary.txt
          echo "Timestamp: ${{ needs.set-environment.outputs.timestamp }} UTC" >> all-checks-summary.txt

          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ✅ All Checks Succeeded
          | Job          | Result   |
          |--------------|----------|
          | Reset Quiet  | ✅ Success |
          | CI           | ✅ Success |

          🌍 Environment: **${{ needs.set-environment.outputs.env_selected }}**  
          🗂️ Retention: **${{ needs.set-environment.outputs.retention_days }} days**  
          🕒 Timestamp: **${{ needs.set-environment.outputs.timestamp }} UTC**

          📎 Summary artifact uploaded below.
          EOF

      - name: Failure summary
        if: "${{ needs.reset_quiet.result != 'success' || needs.ci.result != 'success' }}"
        run: |
          echo "❌ All Checks failed" > all-checks-summary.txt
          echo "Reset Quiet result: ${{ needs.reset_quiet.result }}" >> all-checks-summary.txt
          echo "CI result: ${{ needs.ci.result }}" >> all-checks-summary.txt
          echo "Environment: ${{ needs.set-environment.outputs.env_selected }}" >> all-checks-summary.txt
          echo "Timestamp: ${{ needs.set-environment.outputs.timestamp }} UTC" >> all-checks-summary.txt

          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ❌ All Checks Failed
          | Job          | Result   |
          |--------------|----------|
          | Reset Quiet  | **${{ needs.reset_quiet.result }}** |
          | CI           | **${{ needs.ci.result }}** |

          🌍 Environment: **${{ needs.set-environment.outputs.env_selected }}**  
          🕒 Timestamp: **${{ needs.set-environment.outputs.timestamp }} UTC**

          📎 See artifacts below for details.
          EOF

      - name: Upload All Checks summary
        if: "always()"
        uses: actions/upload-artifact@v4
        with:
          name: all-checks-summary-${{ needs.set-environment.outputs.env_selected }}-${{ github.run_number }}-${{ needs.set-environment.outputs.timestamp }}
          path: all-checks-summary.txt
          retention-days: ${{ needs.set-environment.outputs.retention_days }}

      - name: Print direct artifact link
        if: "always()"
        run: |
          echo "🔗 All Checks summary uploaded: all-checks-summary-${{ needs.set-environment.outputs.env_selected }}-${{ github.run_number }}-${{ needs.set-environment.outputs.timestamp }}"
          echo "👉 Download here: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
