name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - develop
      # Or uncomment to run on all branches
      # - '**'

jobs:
  ci-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20   # Use LTS for consistency with Vercel
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # CI phase-controlled thresholds (default Phase 1 baseline)
      - name: Run CI checks
        run: CI_COVERAGE_PHASE=1 npm run ci-check

      - name: Upload HTML coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

      # --- Dynamic Coverage Phase Badge ---
      - name: Update coverage phase badge
        if: github.ref == 'refs/heads/main'
        run: |
          PHASE=${CI_COVERAGE_PHASE:-1}
          COLOR="blue"
          LABEL="coverage-phase"
          MESSAGE="$PHASE"

          if [ "$PHASE" = "1" ]; then
            MESSAGE="1 (baseline)"
            COLOR="blue"
          elif [ "$PHASE" = "2" ]; then
            MESSAGE="2 (intermediate)"
            COLOR="orange"
          elif [ "$PHASE" = "3" ]; then
            MESSAGE="3 (strict)"
            COLOR="red"
          fi

          cat <<EOF > coverage-phase.json
{
  "schemaVersion": 1,
  "label": "$LABEL",
  "message": "$MESSAGE",
  "color": "$COLOR"
}
EOF

      - name: Commit updated badge JSON
        if: github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): update coverage phase badge"
          file_pattern: coverage-phase.json
